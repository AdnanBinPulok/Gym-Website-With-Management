<aside class="w-full bg-gray-900/50 border border-gray-700 rounded-xl lg:rounded-2xl p-4 lg:p-6 h-full flex flex-col lg:sticky lg:top-24">
    <!-- User Profile Header -->
    <div class="text-center mb-6 lg:mb-8">
        <div class="relative inline-block mb-3 lg:mb-4">
            {% if data.user.avatar_url %}
            <img src="{{ data.user.avatar_url }}" 
                 alt="{{ data.user.full_name or data.user.username }}" 
                 class="w-16 h-16 lg:w-20 lg:h-20 rounded-full object-cover border-4 border-orange-500/20 shadow-lg shadow-orange-500/25">
            {% else %}
            <div class="w-16 h-16 lg:w-20 lg:h-20 bg-gradient-to-br from-orange-500 to-yellow-500 rounded-full flex items-center justify-center border-4 border-orange-500/20 shadow-lg shadow-orange-500/25">
                <i class="fas fa-user text-black text-lg lg:text-2xl"></i>
            </div>
            {% endif %}
            <!-- Status Indicator -->
            <div class="absolute -bottom-0.5 -right-0.5 lg:-bottom-1 lg:-right-1 w-5 h-5 lg:w-6 lg:h-6 {% if data.user.membership_active %}bg-green-500{% else %}bg-gray-500{% endif %} rounded-full border-2 border-gray-900 flex items-center justify-center">
                {% if data.user.membership_active %}
                <i class="fas fa-check text-white text-xs"></i>
                {% else %}
                <i class="fas fa-times text-white text-xs"></i>
                {% endif %}
            </div>
        </div>
        
        <h2 class="text-lg lg:text-xl font-bold text-white mb-1">{{ data.user.full_name or data.user.username }}</h2>
        <p class="text-gray-400 text-sm mb-2">@{{ data.user.username }}</p>
        
        <!-- Membership Status -->
        <div class="inline-flex items-center px-2 lg:px-3 py-1 rounded-full text-xs font-medium {% if data.user.membership_active %}bg-green-500/20 text-green-400 border border-green-500/30{% else %}bg-gray-500/20 text-gray-400 border border-gray-500/30{% endif %}">
            {% if data.user.membership_active %}
                <i class="fas fa-crown mr-1 text-xs"></i>Active Member
            {% else %}
                <i class="fas fa-user mr-1 text-xs"></i>Basic Member
            {% endif %}
        </div>
    </div>
    
    <!-- Navigation Menu -->
    <nav aria-label="Account navigation" class="flex-1">
        <ul class="space-y-1 lg:space-y-2">
            <li>
                <a href="/account" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'profile' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-user {% if active_sidebar == 'profile' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:scale-110 transition-transform duration-300 text-sm lg:text-base"></i>
                    <span class="font-medium text-sm lg:text-base">Profile</span>
                </a>
            </li>
            <li>
                <a href="/account/security" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'security' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-shield-alt {% if active_sidebar == 'security' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:text-orange-500 group-hover:scale-110 transition-all duration-300"></i>
                    <span class="font-medium">Security</span>
                </a>
            </li>
            <li>
                <a href="/account/settings" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'settings' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-cog {% if active_sidebar == 'settings' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:text-orange-500 group-hover:scale-110 transition-all duration-300"></i>
                    <span class="font-medium">Settings</span>
                </a>
            </li>
            <li>
                <a href="/account/payments" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'payments' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-credit-card {% if active_sidebar == 'payments' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:text-orange-500 group-hover:scale-110 transition-all duration-300"></i>
                    <span class="font-medium">Payment History</span>
                </a>
            </li>
            <li>
                <a href="/account/membership" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'membership' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-crown {% if active_sidebar == 'membership' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:text-orange-500 group-hover:scale-110 transition-all duration-300"></i>
                    <span class="font-medium">Membership</span>
                    {% if not data.user.membership_active %}
                    <span class="ml-auto bg-orange-500 text-black text-xs px-2 py-1 rounded-full font-bold">!</span>
                    {% endif %}
                </a>
            </li>
            <li>
                <a href="/account/routine" 
                   class="flex items-center space-x-3 px-3 lg:px-4 py-2 lg:py-3 rounded-xl text-gray-300 hover:text-orange-500 hover:bg-gray-800/50 transition-all duration-300 group
                   {% if active_sidebar == 'routine' %}bg-orange-500/10 text-orange-500 border border-orange-500/30{% endif %}">
                    <i class="fas fa-dumbbell {% if active_sidebar == 'routine' %}text-orange-500{% else %}text-gray-400{% endif %} group-hover:text-orange-500 group-hover:scale-110 transition-all duration-300"></i>
                    <span class="font-medium">My Routine</span>
                    {% if data.user.routine %}
                    <span class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-full font-bold">✓</span>
                    {% else %}
                    <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full font-bold">✗</span>
                    {% endif %}
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Quick Stats -->
    <div class="mt-4 lg:mt-8 pt-4 lg:pt-6 border-t border-gray-700">
        <h3 class="text-white font-semibold text-sm mb-3 lg:mb-4">Quick Stats</h3>
        <div class="space-y-2 lg:space-y-3">
            <!-- Card ID with Card Design -->
            <div class="bg-gradient-to-r from-gray-800 to-gray-700 border border-gray-600 rounded-xl p-3 relative overflow-hidden">
                <!-- Card Background Pattern -->
                <div class="absolute inset-0 opacity-10">
                    <div class="absolute inset-0 bg-[linear-gradient(45deg,rgba(255,107,53,0.3)_1px,transparent_1px),linear-gradient(-45deg,rgba(255,107,53,0.3)_1px,transparent_1px)] bg-[size:20px_20px]"></div>
                </div>
                
                <div class="relative z-10">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-xs font-medium">MEMBER CARD</span>
                        <i class="fas fa-id-card text-orange-500 text-sm"></i>
                    </div>
                    
                    {% if data.user.card_id %}
                    <div class="font-mono text-orange-500 font-bold text-sm tracking-wider">{{ data.user.card_id }}</div>
                    <div class="text-gray-400 text-xs mt-1">{{ data.user.full_name or data.user.username }}</div>
                    {% else %}
                    <div class="text-gray-500 text-xs italic">Card not assigned</div>
                    <div class="text-yellow-500 text-xs mt-1">
                        <i class="fas fa-exclamation-triangle mr-1"></i>Contact admin
                    </div>
                    {% endif %}
                </div>
                
                <!-- Card chip design -->
                <div class="absolute top-2 right-2 w-6 h-4 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-sm opacity-20"></div>
            </div>
            
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Account Balance</span>
                <span class="text-orange-500 font-bold">{{ data.site.currency.symbol or '৳' }}{{ data.user.balance or '0.00' }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Member Since</span>
                <span class="text-gray-300 text-sm">
                    {% if data.user.created_at %}
                        {% if data.user.created_at is string %}
                            {{ data.user.created_at[:7] if data.user.created_at|length >= 7 else 'N/A' }}
                        {% else %}
                            {{ data.user.created_at.strftime('%b %Y') }}
                        {% endif %}
                    {% else %}
                        N/A
                    {% endif %}
                </span>
            </div>
            {% if data.user.membership_active and data.user.membership_end_date %}
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Expires</span>
                <span class="text-gray-300 text-sm">
                    {% if data.user.membership_end_date is string %}
                        {{ data.user.membership_end_date[:10] if data.user.membership_end_date|length >= 10 else 'N/A' }}
                    {% else %}
                        {{ data.user.membership_end_date.strftime('%d %b %Y') }}
                    {% endif %}
                </span>
            </div>
            {% endif %}
            {% if data.user.membership_active and data.user.membership_payment_cycle %}
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Billing</span>
                <span class="text-orange-400 text-sm font-medium">{{ data.user.membership_payment_cycle.title() }}</span>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="mt-4 lg:mt-8 pt-4 lg:pt-6 border-t border-gray-700 space-y-2 lg:space-y-3">
        {% if not data.user.membership_active %}
        <a href="/pricing" 
           class="block w-full bg-gradient-to-r from-orange-500 to-yellow-500 text-black px-4 py-3 rounded-xl font-bold text-center hover:shadow-lg hover:shadow-orange-500/25 transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-crown mr-2"></i>Upgrade Membership
        </a>
        {% endif %}
        
        <a href="/contact" 
           class="block w-full border-2 border-gray-600 hover:border-orange-500 text-gray-300 hover:text-orange-500 px-4 py-3 rounded-xl font-bold text-center transition-all duration-300">
            <i class="fas fa-headset mr-2"></i>Contact Support
        </a>
        
        <button onclick="openLogoutModal()" 
                class="block w-full border-2 border-red-500/30 hover:border-red-500 text-red-400 hover:text-red-500 hover:bg-red-500/10 px-4 py-3 rounded-xl font-bold text-center transition-all duration-300">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
    </div>
</aside>

<!-- Logout Confirmation Modal -->
<div id="logout-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
    <div class="bg-gradient-to-br from-gray-900 to-gray-800 border border-gray-700 rounded-2xl p-6 sm:p-8 max-w-md w-full mx-4">
        <!-- Modal Header -->
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-white">Confirm Logout</h3>
            <button onclick="closeLogoutModal()" class="text-gray-400 hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        
        <!-- Modal Content -->
        <div class="mb-6">
            <div class="w-16 h-16 bg-gradient-to-r from-red-500 to-red-400 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-sign-out-alt text-white text-2xl"></i>
            </div>
            <p class="text-gray-300 text-center leading-relaxed">
                Are you sure you want to logout? You will need to sign in again to access your account.
            </p>
        </div>
        
        <!-- Error Message -->
        <div id="logout-error-message" class="hidden bg-red-500/10 border border-red-500/30 rounded-xl p-4 mb-6">
            <div class="flex items-start space-x-3">
                <i class="fas fa-exclamation-triangle text-red-400 mt-0.5 flex-shrink-0"></i>
                <div>
                    <h4 class="text-red-400 font-semibold text-sm mb-1">Logout Failed</h4>
                    <p class="text-red-300 text-xs sm:text-sm" id="logout-error-text"></p>
                </div>
            </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="flex flex-col sm:flex-row gap-3">
            <button onclick="performLogout()" 
                    id="logout-confirm-btn"
                    class="flex-1 bg-gradient-to-r from-red-500 to-red-400 text-white px-6 py-3 rounded-xl font-bold hover:shadow-lg hover:shadow-red-500/25 transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-sign-out-alt mr-2"></i>Yes, Logout
            </button>
            <button onclick="closeLogoutModal()" 
                    class="flex-1 border-2 border-gray-600 hover:border-gray-500 text-gray-300 hover:text-gray-200 px-6 py-3 rounded-xl font-bold transition-all duration-300">
                Cancel
            </button>
        </div>
    </div>
</div>

<script>
// Logout Modal Functions
function openLogoutModal() {
    document.getElementById('logout-modal').classList.remove('hidden');
    hideLogoutError();
    document.body.style.overflow = 'hidden';
}

function closeLogoutModal() {
    document.getElementById('logout-modal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function hideLogoutError() {
    document.getElementById('logout-error-message').classList.add('hidden');
}

function showLogoutError(message) {
    const errorDiv = document.getElementById('logout-error-message');
    const errorText = document.getElementById('logout-error-text');
    errorText.textContent = message;
    errorDiv.classList.remove('hidden');
    errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

async function performLogout() {
    hideLogoutError();
    
    const submitBtn = document.getElementById('logout-confirm-btn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Logging out...';
    submitBtn.disabled = true;
    
    try {
        const response = await fetch('/api/logout', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            const errorMessage = data.message || data.error || 'Failed to logout';
            showLogoutError(errorMessage);
        } else {
            // Success - show success message and redirect
            submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Logged out!';
            submitBtn.classList.remove('from-red-500', 'to-red-400');
            submitBtn.classList.add('from-green-500', 'to-green-400');
            
            // Redirect to home page after successful logout
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        }
        
    } catch (error) {
        console.error('Logout error:', error);
        showLogoutError('Connection error. Please check your internet connection and try again.');
    } finally {
        // Reset button state if there was an error
        if (submitBtn.innerHTML.includes('spinner')) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }
}

// Close modal when clicking outside
document.getElementById('logout-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeLogoutModal();
    }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeLogoutModal();
    }
});

// Legacy function for backward compatibility
function logout() {
    openLogoutModal();
}

async function selectTheMenuItem(item) {
    const menuItems = document.querySelectorAll('.account-menu-item');
    menuItems.forEach(el => el.classList.remove('active'));
    
    const selectedItem = document.querySelector(`.account-menu-item[data-item="${item}"]`);
    if (selectedItem) {
        selectedItem.classList.add('active');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Select the current menu item based on the URL
    const currentPath = window.location.pathname;
    const menuItems = document.querySelectorAll('.account-menu-item');
    
    menuItems.forEach(item => {
        if (currentPath.includes(item.getAttribute('data-item'))) {
            item.classList.add('active');
        }
    });
});

</script>