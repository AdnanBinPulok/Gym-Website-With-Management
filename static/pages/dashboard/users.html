<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Users Management - {{ data.site.name or 'Aesthetic Fitness Gym' }}</title>
    
    <!-- Preload critical resources first -->
    <link rel="preload" href="{{data.site.logo or '/images/logo.png' }}" as="image">
    <link rel="preload" href="{{data.site.favicon or '/images/favicon.png' }}" as="image">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" as="style">
    
    <meta name="description" content="{{ data.site.meta_description or 'Aesthetic Fitness Gym is the best place to achieve your fitness goals!' }}">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="shortcut icon" href="{{data.site.favicon or '/images/favicon.png' }}" type="image/x-icon">
    <link rel="stylesheet" href="/static/styles/colors.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Dark theme styles to match dashboard */
        body {
            background-color: #0f172a !important;
            color: #e2e8f0 !important;
        }
    </style>
</head><body>
    {% set active_page = 'users' %}
    {% include 'components/dashboard-sidebar.html' %}
    <div class="lg:ml-64 min-h-screen p-2 md:p-4 lg:p-6">
        <div class="border border-slate-600 rounded-lg shadow-lg p-6 mb-2">
            <h1 class="text-2xl font-bold">User Management</h1>
            <p class="text-gray-400">Manage gym members, trainers, and staff accounts</p>
        </div>

        <div class="user-container border border-slate-600 rounded-lg shadow-lg p-6 mb-2">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Users List</h2>
                    <p class="text-gray-400">View and manage all registered users</p>
                </div>
                <button onclick="showCreateUserModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-500 transition-colors font-semibold">
                    <i class="fas fa-plus mr-2"></i>Create New User
                </button>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="mb-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Search -->
                    <input type="text" id="search-input" placeholder="Search users..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- User ID Filter -->
                    <input type="number" id="user-id-filter" placeholder="Filter by User ID..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Card ID Filter -->
                    <input type="text" id="card-id-filter" placeholder="Filter by Card ID..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Full Name Filter -->
                    <input type="text" id="full-name-filter" placeholder="Filter by Full Name..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Username Filter -->
                    <input type="text" id="username-filter" placeholder="Filter by Username..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Email Filter -->
                    <input type="email" id="email-filter" placeholder="Filter by Email..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Phone Filter -->
                    <input type="tel" id="phone-filter" placeholder="Filter by Phone..." class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                    
                    <!-- Membership Active Filter -->
                    <select id="membership-filter" class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                        <option value="">All Memberships</option>
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                    
                    <!-- Membership Type Filter -->
                    <select id="membership-type-filter" class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                        <option value="">All Types</option>
                        <option value="Basic">Basic</option>
                        <option value="Premium">Premium</option>
                        <option value="VIP">VIP</option>
                        <option value="Student">Student</option>
                        <option value="Senior">Senior</option>
                    </select>
                    
                    <!-- Membership Cancelled Filter -->
                    <select id="membership-cancelled-filter" class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                        <option value="">All Statuses</option>
                        <option value="false">Not Cancelled</option>
                        <option value="true">Cancelled</option>
                    </select>
                    
                    <!-- Order By -->
                    <select id="order-by" class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                        <option value="id">Order by ID</option>
                        <option value="full_name">Order by Name</option>
                        <option value="username">Order by Username</option>
                        <option value="email">Order by Email</option>
                        <option value="created_at">Order by Created Date</option>
                        <option value="updated_at">Order by Updated Date</option>
                        <option value="last_login">Order by Last Login</option>
                        <option value="membership_start_date">Order by Membership Start</option>
                        <option value="membership_end_date">Order by Membership End</option>
                        <option value="membership_renewal_date">Order by Renewal Date</option>
                    </select>
                    
                    <!-- Order Direction -->
                    <select id="order-direction" class="bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>
                
                <!-- Clear Filters Button -->
                <div class="flex justify-end">
                    <button id="clear-filters-btn" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-colors">
                        <i class="fas fa-times mr-2"></i>Clear All Filters
                    </button>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="loading-state" class="text-center py-8">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-400"></i>
                <p class="text-gray-400 mt-2">Loading users...</p>
            </div>
            
            <!-- Users List -->
            <div class="users-list space-y-4" id="users-list" style="display: none;">
                <!-- Users will be populated by JavaScript -->
            </div>
            
            <!-- No Users State -->
            <div id="no-users-state" class="text-center py-8" style="display: none;">
                <i class="fas fa-users text-4xl text-gray-500"></i>
                <p class="text-gray-400 mt-2">No users found</p>
            </div>
            
            <div class="pagination flex justify-center items-center mt-6" id="pagination" style="display: none;">
                <button class="prev-page bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50" disabled id="prev-page-btn">Previous</button>
                <span class="page-info text-gray-300 mx-4">Page <span id="current-page">1</span> of <span id="total-pages">1</span></span>
                <button class="next-page bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors disabled:opacity-50" disabled id="next-page-btn">Next</button>
            </div>
        </div>
    </div>
    
    <!-- User Detail Modal -->
    <div id="user-detail-modal" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden backdrop-blur-sm">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl border border-slate-700/50">
                <div class="sticky top-0 bg-gradient-to-r from-slate-800 to-slate-700 p-6 rounded-t-xl border-b border-slate-600/50">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-user-circle mr-3 text-blue-400"></i>
                            User Details
                        </h2>
                        <button onclick="closeUserModal()" class="text-gray-400 hover:text-white text-2xl transition-colors duration-200 hover:bg-slate-600 p-2 rounded-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- User Detail Content -->
                <div class="p-6" id="user-detail-content">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="delete-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-800 rounded-lg max-w-md w-full">
                <div class="p-6">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-white">Confirm Delete User</h2>
                        <button onclick="closeDeleteModal()" class="text-gray-400 hover:text-white text-xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- User Info -->
                    <div id="delete-user-info" class="mb-6">
                        <!-- User info will be populated by JavaScript -->
                    </div>
                    
                    <!-- Warning -->
                    <div class="bg-red-900/30 border border-red-600 rounded-lg p-4 mb-6">
                        <div class="flex">
                            <i class="fas fa-exclamation-triangle text-red-400 mr-3 mt-1"></i>
                            <div>
                                <h3 class="text-red-400 font-semibold mb-2">Warning!</h3>
                                <p class="text-gray-300 text-sm">This action cannot be undone. All user data, including membership information, will be permanently deleted.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Confirmation Input -->
                    <div class="mb-6">
                        <label class="block text-gray-300 text-sm mb-2">
                            Type "DELETE" to confirm:
                        </label>
                        <input type="text" id="delete-confirmation-input" placeholder="Type DELETE here" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-red-500">
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button onclick="closeDeleteModal()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition-colors">
                            Cancel
                        </button>
                        <button id="confirm-delete-btn" onclick="executeDeleteUser()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <i class="fas fa-trash mr-2"></i>Delete User
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create User Modal -->
    <div id="create-user-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-slate-800 rounded-lg max-w-lg w-full border border-slate-600">
                <div class="p-6">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-user-plus mr-3 text-blue-400"></i>
                            Create New User
                        </h2>
                        <button onclick="closeCreateUserModal()" class="text-gray-400 hover:text-white text-xl transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Create User Form -->
                    <form id="create-user-form">
                        <div class="space-y-4">
                            <!-- Full Name -->
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">
                                    Full Name <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="create-full-name" required class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" placeholder="Enter full name">
                            </div>
                            
                            <!-- Username -->
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">
                                    Username <span class="text-red-400">*</span>
                                </label>
                                <input type="text" id="create-username" required class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" placeholder="Enter username">
                            </div>
                            
                            <!-- Email -->
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">
                                    Email <span class="text-red-400">*</span>
                                </label>
                                <input type="email" id="create-email" required class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" placeholder="Enter email address">
                            </div>
                            
                            <!-- Card ID -->
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">
                                    Card ID <span class="text-gray-500">(Optional)</span>
                                </label>
                                <input type="text" id="create-card-id" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" placeholder="Enter card ID or leave empty for auto-generation">
                            </div>
                            
                            <!-- Phone -->
                            <div>
                                <label class="block text-gray-300 text-sm font-medium mb-2">
                                    Phone <span class="text-gray-500">(Optional)</span>
                                </label>
                                <input type="tel" id="create-phone" class="w-full bg-slate-700 text-white p-3 rounded-lg border border-slate-600 focus:border-blue-500 focus:outline-none" placeholder="Enter phone number">
                            </div>
                        </div>
                        
                        <!-- Form Actions -->
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="closeCreateUserModal()" class="flex-1 bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-500 transition-colors font-medium">
                                Cancel
                            </button>
                            <button type="submit" id="create-user-btn" class="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-500 transition-colors font-medium">
                                <i class="fas fa-plus mr-2"></i>Create User
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    let currentPage = 1;
    let totalPages = 1;
    let usersData = [];

    const CURRENCY_SYMBOL = "{{ data.site.currency.symbol or '$'}}"; // Use the configured currency symbol

    // Fetch users from API
    async function fetchUsers() {
        try {
            showLoading();
            
            const params = new URLSearchParams({
                page: currentPage,
                limit: 10,
                order_by: document.getElementById('order-by').value || 'id',
                order: document.getElementById('order-direction').value || 'asc'
            });
            
            // Add all filters if they have values
            const search = document.getElementById('search-input').value.trim();
            if (search) params.append('search', search);
            
            const userId = document.getElementById('user-id-filter').value.trim();
            if (userId) params.append('user_id', userId);
            
            const cardId = document.getElementById('card-id-filter').value.trim();
            if (cardId) params.append('card_id', cardId);
            
            const fullName = document.getElementById('full-name-filter').value.trim();
            if (fullName) params.append('full_name', fullName);
            
            const username = document.getElementById('username-filter').value.trim();
            if (username) params.append('username', username);
            
            const email = document.getElementById('email-filter').value.trim();
            if (email) params.append('email', email);
            
            const phone = document.getElementById('phone-filter').value.trim();
            if (phone) params.append('phone', phone);
            
            const membershipFilter = document.getElementById('membership-filter').value;
            if (membershipFilter) params.append('membership_active', membershipFilter);
            
            const membershipTypeFilter = document.getElementById('membership-type-filter').value;
            if (membershipTypeFilter) params.append('membership_type', membershipTypeFilter);
            
            const membershipCancelledFilter = document.getElementById('membership-cancelled-filter').value;
            if (membershipCancelledFilter) params.append('membership_cancelled', membershipCancelledFilter);
            
            const response = await fetch(`/api/get-users?${params}`);
            if (!response.ok) {
                throw new Error('Failed to fetch users');
            }
            
            const data = await response.json();
            
            if (data.success) {
                usersData = data.data || [];
                totalPages = Math.ceil((data.count_total || 0) / 10);
                renderUsers();
                updatePagination();
            } else {
                throw new Error(data.message || 'Failed to fetch users');
            }
            
        } catch (error) {
            console.error('Error fetching users:', error);
            showError();
        }
    }
    
    // Render users in the UI
    function renderUsers() {
        const usersList = document.getElementById('users-list');
        const noUsersState = document.getElementById('no-users-state');
        const loadingState = document.getElementById('loading-state');
        
        loadingState.style.display = 'none';
        
        if (usersData.length === 0) {
            usersList.style.display = 'none';
            noUsersState.style.display = 'block';
            document.getElementById('pagination').style.display = 'none';
            return;
        }
        
        noUsersState.style.display = 'none';
        usersList.style.display = 'block';
        document.getElementById('pagination').style.display = 'flex';
        
        usersList.innerHTML = usersData.map(user => createUserCard(user)).join('');
    }
    
    // Create user card HTML
    function createUserCard(user) {
        const avatar = user.avatar_url ? 
            `<img src="${user.avatar_url}" alt="${user.full_name}" class="w-16 h-16 rounded-full object-cover">` :
            `<div class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                <span class="text-white font-semibold text-lg">${getInitials(user.full_name)}</span>
            </div>`;
        
        const membershipStatus = user.membership_active ? 
            '<span class="bg-green-600 text-white px-2 py-1 rounded text-sm">Active</span>' :
            '<span class="bg-red-600 text-white px-2 py-1 rounded text-sm">Inactive</span>';
        
        const emailVerified = user.email_verified ?
            '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-check mr-1"></i>Verified</span>' :
            '<span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-times mr-1"></i>Not Verified</span>';
        
        const phoneVerified = user.phone_verified ?
            '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-check mr-1"></i>Verified</span>' :
            '<span class="bg-yellow-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-clock mr-1"></i>Pending</span>';
        
        return `
            <div class="user-card border border-slate-600 rounded-lg p-6 bg-slate-800">
                <div class="flex flex-col lg:flex-row lg:items-start gap-6">
                    <!-- User Avatar and Basic Info -->
                    <div class="flex items-center space-x-4">
                        ${avatar}
                        <div>
                            <h3 class="text-xl font-semibold text-white">#${user.id} - ${user.full_name || 'N/A'}</h3>
                            <p class="text-gray-400">@${user.username || 'N/A'}</p>
                            <p class="text-gray-400 text-sm">${user.email || 'N/A'}</p>
                            <p class="text-gray-400 text-sm">${user.phone || 'No phone'}</p>
                        </div>
                    </div>
                    
                    <!-- User Details Section -->
                    <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Basic Information -->
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Basic Info</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Card ID:</span>
                                    <span class="text-white">${user.card_id || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Role:</span>
                                    <span class="bg-blue-600 text-white px-2 py-1 rounded text-sm">${user.role || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Balance:</span>
                                    <span class="text-green-400 font-semibold">${CURRENCY_SYMBOL}${parseFloat(user.balance || 0).toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Email Verified:</span>
                                    ${emailVerified}
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Phone Verified:</span>
                                    ${phoneVerified}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Membership Information -->
                        <div class="space-y-3">
                            <h4 class="text-lg font-semibold text-white border-b border-slate-600 pb-2">Membership</h4>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Status:</span>
                                    ${membershipStatus}
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Type:</span>
                                    <span class="bg-purple-600 text-white px-2 py-1 rounded text-sm">${user.membership_type || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Start Date:</span>
                                    <span class="text-white">${formatDate(user.membership_start_date)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">End Date:</span>
                                    <span class="text-white">${formatDate(user.membership_end_date)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Payment Cycle:</span>
                                    <span class="text-white">${user.membership_payment_cycle || 'N/A'}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Renewal Date:</span>
                                    <span class="text-white">${formatDate(user.membership_renewal_date)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Renewal Price:</span>
                                    <span class="text-green-400 font-semibold">$${parseFloat(user.membership_renewal_price || 0).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Info and Actions -->
                <div class="mt-6 pt-4 border-t border-slate-600">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="text-gray-400">Last Login:</span>
                                <p class="text-white">${formatDateTime(user.last_login)}</p>
                            </div>
                            <div>
                                <span class="text-gray-400">Created:</span>
                                <p class="text-white">${formatDateTime(user.created_at)}</p>
                            </div>
                            <div>
                                <span class="text-gray-400">Updated:</span>
                                <p class="text-white">${formatDateTime(user.updated_at)}</p>
                            </div>
                            <div>
                                <span class="text-gray-400">Cancelled:</span>
                                <p class="${user.membership_cancelled ? 'text-red-400' : 'text-green-400'}">${user.membership_cancelled ? 'Yes' : 'No'}</p>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2">
                            <button class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-400 transition-colors" onclick="viewUser(${user.id})">
                                <i class="fas fa-eye mr-1"></i>View
                            </button>
                            <a href="/dashboard/edit-user/${user.id}" class="bg-green-500 text-white px-4 py-2 rounded text-sm hover:bg-green-400 transition-colors inline-flex items-center">
                                <i class="fas fa-edit mr-1"></i>Edit
                            </a>
                            <button class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-400 transition-colors" onclick="confirmDeleteUser(${user.id})">
                                <i class="fas fa-trash mr-1"></i>Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Utility functions
    function getInitials(name) {
        if (!name) return 'U';
        return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }
    
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleDateString();
    }
    
    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        return new Date(dateString).toLocaleString();
    }
    
    function showLoading() {
        document.getElementById('loading-state').style.display = 'block';
        document.getElementById('users-list').style.display = 'none';
        document.getElementById('no-users-state').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }
    
    function showError() {
        document.getElementById('loading-state').style.display = 'none';
        document.getElementById('users-list').style.display = 'none';
        document.getElementById('no-users-state').style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
        
        document.getElementById('no-users-state').innerHTML = `
            <i class="fas fa-exclamation-triangle text-4xl text-red-500"></i>
            <p class="text-gray-400 mt-2">Error loading users. Please try again.</p>
        `;
    }
    
    // Pagination functions
    function updatePagination() {
        document.getElementById('current-page').textContent = currentPage;
        document.getElementById('total-pages').textContent = totalPages;
        
        const prevBtn = document.getElementById('prev-page-btn');
        const nextBtn = document.getElementById('next-page-btn');
        
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
    }
    
    function goToPage(page) {
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            fetchUsers();
        }
    }
    
    // Event listeners
    document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPage - 1));
    document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPage + 1));
    
    // Search and filter event listeners
    let searchTimeout;
    
    // Debounced search for text inputs
    function addDebounceListener(elementId) {
        document.getElementById(elementId).addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 1;
                fetchUsers();
            }, 500);
        });
    }
    
    // Immediate filter for select elements
    function addFilterListener(elementId) {
        document.getElementById(elementId).addEventListener('change', () => {
            currentPage = 1;
            fetchUsers();
        });
    }
    
    // Add listeners for all filters
    addDebounceListener('search-input');
    addDebounceListener('user-id-filter');
    addDebounceListener('card-id-filter');
    addDebounceListener('full-name-filter');
    addDebounceListener('username-filter');
    addDebounceListener('email-filter');
    addDebounceListener('phone-filter');
    
    addFilterListener('membership-filter');
    addFilterListener('membership-type-filter');
    addFilterListener('membership-cancelled-filter');
    addFilterListener('order-by');
    addFilterListener('order-direction');
    
    // Clear all filters
    document.getElementById('clear-filters-btn').addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        document.getElementById('user-id-filter').value = '';
        document.getElementById('card-id-filter').value = '';
        document.getElementById('full-name-filter').value = '';
        document.getElementById('username-filter').value = '';
        document.getElementById('email-filter').value = '';
        document.getElementById('phone-filter').value = '';
        document.getElementById('membership-filter').value = '';
        document.getElementById('membership-type-filter').value = '';
        document.getElementById('membership-cancelled-filter').value = '';
        document.getElementById('order-by').value = 'id';
        document.getElementById('order-direction').value = 'asc';
        
        currentPage = 1;
        fetchUsers();
    });
    
    // User action functions
    function viewUser(userId) {
        const user = usersData.find(u => u.id == userId);
        if (user) {
            showUserDetailModal(user);
        } else {
            console.error('User not found:', userId);
        }
    }
    
    function showUserDetailModal(user) {
        const modal = document.getElementById('user-detail-modal');
        const content = document.getElementById('user-detail-content');
        
        const avatar = user.avatar_url ? 
            `<img src="${user.avatar_url}" alt="${user.full_name}" class="w-32 h-32 rounded-full object-cover mx-auto border-4 border-blue-500/30 shadow-xl">` :
            `<div class="w-32 h-32 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto border-4 border-blue-500/30 shadow-xl">
                <span class="text-white font-bold text-3xl">${getInitials(user.full_name)}</span>
            </div>`;
        
        const membershipStatus = user.membership_active ? 
            '<span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg"><i class="fas fa-check-circle mr-1"></i>Active</span>' :
            '<span class="bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg"><i class="fas fa-times-circle mr-1"></i>Inactive</span>';
        
        const emailVerified = user.email_verified ?
            '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-check mr-1"></i>Verified</span>' :
            '<span class="bg-red-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-times mr-1"></i>Not Verified</span>';
        
        const phoneVerified = user.phone_verified ?
            '<span class="bg-green-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-check mr-1"></i>Verified</span>' :
            '<span class="bg-yellow-600 text-white px-3 py-1 rounded-full text-xs font-medium"><i class="fas fa-clock mr-1"></i>Pending</span>';
        
        // Check if renewal date is within 3 days
        const isRenewalSoon = checkRenewalWarning(user.membership_renewal_date);
        const renewalDateDisplay = isRenewalSoon ? 
            `<div class="text-center relative">
                <div class="text-gray-400 text-sm mb-1">Renewal Date</div>
                <div class="text-red-400 font-bold animate-pulse">${formatDate(user.membership_renewal_date)}</div>
                <div class="absolute -top-1 -right-1">
                    <span class="bg-red-500 text-white text-xs px-1 py-0.5 rounded-full animate-pulse">
                        <i class="fas fa-exclamation-triangle"></i>
                    </span>
                </div>
            </div>` :
            `<div class="text-center">
                <div class="text-gray-400 text-sm mb-1">Renewal Date</div>
                <div class="text-white font-semibold">${formatDate(user.membership_renewal_date)}</div>
            </div>`;
        
        content.innerHTML = `
            <div class="space-y-8">
                <!-- User Profile Header -->
                ${isRenewalSoon ? `
                    <div class="bg-red-900/30 border border-red-500/50 rounded-xl p-4 mb-6">
                        <div class="flex items-center text-red-400">
                            <i class="fas fa-exclamation-triangle mr-3 text-lg animate-pulse"></i>
                            <div>
                                <h4 class="font-semibold">Membership Renewal Warning</h4>
                                <p class="text-sm text-red-300">This user's membership renewal is due within 3 days (${formatDate(user.membership_renewal_date)})</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="text-center bg-gradient-to-r from-slate-700/50 to-slate-600/50 rounded-xl p-8 border border-slate-600/50">
                    ${avatar}
                    <h3 class="text-3xl font-bold text-white mt-6">${user.full_name || 'N/A'}</h3>
                    <p class="text-gray-300 text-xl mt-2">@${user.username || 'N/A'}</p>
                    <p class="text-blue-400 mt-2 font-medium">${user.email || 'N/A'}</p>
                    <div class="mt-4">
                        ${membershipStatus}
                    </div>
                    <div class="mt-4 text-gray-400">
                        <i class="fas fa-id-badge mr-2"></i>User ID: <span class="text-white font-semibold">#${user.id}</span>
                    </div>
                </div>
                
                <!-- Information Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Personal Information -->
                    <div class="bg-gradient-to-br from-slate-700/30 to-slate-600/30 rounded-xl p-6 border border-slate-600/50">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-user mr-3 text-blue-400"></i>Personal Information
                        </h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Card ID:</span>
                                <span class="text-white font-semibold">${user.card_id || 'Not assigned'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Full Name:</span>
                                <span class="text-white font-semibold">${user.full_name || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Username:</span>
                                <span class="text-white font-semibold">@${user.username || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Email:</span>
                                <span class="text-white font-semibold">${user.email || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Phone:</span>
                                <span class="text-white font-semibold">${user.phone || 'Not provided'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Role:</span>
                                <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium">${user.role || 'N/A'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400 font-medium">Balance:</span>
                                <span class="text-green-400 font-bold text-xl">${CURRENCY_SYMBOL}${parseFloat(user.balance || 0).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Status -->
                    <div class="bg-gradient-to-br from-slate-700/30 to-slate-600/30 rounded-xl p-6 border border-slate-600/50">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-shield-alt mr-3 text-green-400"></i>Account Status
                        </h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Email Verified:</span>
                                ${emailVerified}
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Phone Verified:</span>
                                ${phoneVerified}
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Profile Picture:</span>
                                <span class="text-white font-semibold">${user.avatar_url ? 'Custom' : 'Default'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Account Created:</span>
                                <span class="text-white font-semibold">${formatDateTime(user.created_at)}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-slate-600/30">
                                <span class="text-gray-400 font-medium">Last Updated:</span>
                                <span class="text-white font-semibold">${formatDateTime(user.updated_at)}</span>
                            </div>
                            <div class="flex justify-between items-center py-2">
                                <span class="text-gray-400 font-medium">Last Login:</span>
                                <span class="text-white font-semibold">${formatDateTime(user.last_login)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Membership Information -->
                <div class="bg-gradient-to-br from-purple-900/20 to-blue-900/20 rounded-xl p-6 border border-purple-500/30">
                    <h4 class="text-xl font-bold text-white mb-6 flex items-center">
                        <i class="fas fa-id-card mr-3 text-purple-400"></i>Membership Information
                        ${isRenewalSoon ? '<span class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full animate-pulse"><i class="fas fa-exclamation-triangle mr-1"></i>Renewal Due Soon</span>' : ''}
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Status</div>
                                ${membershipStatus}
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Type</div>
                                <span class="bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-medium">${user.membership_type || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Payment Cycle</div>
                                <div class="text-white font-semibold">${user.membership_payment_cycle || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Start Date</div>
                                <div class="text-white font-semibold">${formatDate(user.membership_start_date)}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">End Date</div>
                                <div class="text-white font-semibold">${formatDate(user.membership_end_date)}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Renewal Date</div>
                                <div class="text-white font-semibold">${formatDate(user.membership_renewal_date)}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Renewal Price</div>
                                <div class="text-green-400 font-bold text-lg">$${parseFloat(user.membership_renewal_price || 0).toFixed(2)}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Renewal By</div>
                                <div class="text-white font-semibold">${user.membership_renewal_by || 'N/A'}</div>
                            </div>
                        </div>
                        <div class="bg-slate-700/50 rounded-lg p-4">
                            <div class="text-center">
                                <div class="text-gray-400 text-sm mb-1">Cancelled</div>
                                ${user.membership_cancelled ? `
                                    <div class="text-red-400 font-semibold">Yes</div>
                                ` : `
                                    <div class="text-green-400 font-semibold">No</div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    ${user.membership_cancelled ? `
                        <div class="mt-6 bg-red-900/30 border border-red-600/50 rounded-lg p-4">
                            <h5 class="text-red-400 font-semibold mb-3">Cancellation Details</h5>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div>
                                    <span class="text-gray-400">Reason:</span>
                                    <p class="text-white font-semibold">${user.membership_cancelled_reason || 'N/A'}</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Cancelled At:</span>
                                    <p class="text-white font-semibold">${formatDateTime(user.membership_cancelled_at)}</p>
                                </div>
                                <div>
                                    <span class="text-gray-400">Cancelled By:</span>
                                    <p class="text-white font-semibold">${user.membership_cancelled_by || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Workout Routine -->
                ${user.routine ? `
                    <div class="bg-gradient-to-br from-orange-900/20 to-red-900/20 rounded-xl p-6 border border-orange-500/30">
                        <h4 class="text-xl font-bold text-white mb-6 flex items-center">
                            <i class="fas fa-dumbbell mr-3 text-orange-400"></i>Workout Routine
                        </h4>
                        <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-600/50">
                            <pre class="text-gray-300 whitespace-pre-wrap text-sm leading-relaxed font-mono">${user.routine}</pre>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Action Buttons -->
                <div class="flex flex-wrap gap-4 pt-6 border-t border-slate-600/50">
                    <a href="/dashboard/edit-user/${user.id}" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-emerald-700 transition-all duration-200 inline-flex items-center font-semibold shadow-lg transform hover:scale-105">
                        <i class="fas fa-edit mr-2"></i>Edit User
                    </a>
                    <button class="bg-gradient-to-r from-red-500 to-red-600 text-white px-6 py-3 rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 font-semibold shadow-lg transform hover:scale-105" onclick="confirmDeleteUser(${user.id})">
                        <i class="fas fa-trash mr-2"></i>Delete User
                    </button>
                </div>
            </div>
        `;
        
        modal.classList.remove('hidden');
    }
    
    // Add utility function to check renewal warning
    function checkRenewalWarning(renewalDateString) {
        if (!renewalDateString) return false;
        
        const renewalDate = new Date(renewalDateString);
        const today = new Date();
        const threeDaysFromNow = new Date();
        threeDaysFromNow.setDate(today.getDate() + 3);
        
        // Check if renewal date is between today and 3 days from now
        return renewalDate >= today && renewalDate <= threeDaysFromNow;
    }
    
    function closeUserModal() {
        document.getElementById('user-detail-modal').classList.add('hidden');
    }
    
    let userToDelete = null;
    
    function confirmDeleteUser(userId) {
        const user = usersData.find(u => u.id == userId);
        if (user) {
            userToDelete = user;
            showDeleteConfirmationModal(user);
        } else {
            console.error('User not found:', userId);
        }
    }
    
    function showDeleteConfirmationModal(user) {
        const modal = document.getElementById('delete-confirmation-modal');
        const userInfo = document.getElementById('delete-user-info');
        const confirmationInput = document.getElementById('delete-confirmation-input');
        const confirmBtn = document.getElementById('confirm-delete-btn');
        
        const avatar = user.avatar_url ? 
            `<img src="${user.avatar_url}" alt="${user.full_name}" class="w-12 h-12 rounded-full object-cover">` :
            `<div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                <span class="text-white font-semibold">${getInitials(user.full_name)}</span>
            </div>`;
        
        userInfo.innerHTML = `
            <div class="flex items-center space-x-3 p-3 bg-slate-700 rounded-lg">
                ${avatar}
                <div>
                    <h3 class="text-white font-semibold">${user.full_name || 'N/A'}</h3>
                    <p class="text-gray-400 text-sm">@${user.username || 'N/A'}</p>
                    <p class="text-gray-400 text-sm">${user.email || 'N/A'}</p>
                </div>
            </div>
        `;
        
        // Reset form
        confirmationInput.value = '';
        confirmBtn.disabled = true;
        
        modal.classList.remove('hidden');
    }
    
    function closeDeleteModal() {
        document.getElementById('delete-confirmation-modal').classList.add('hidden');
        userToDelete = null;
        document.getElementById('delete-confirmation-input').value = '';
        document.getElementById('confirm-delete-btn').disabled = true;
    }
    
    async function executeDeleteUser() {
        if (!userToDelete) {
            console.error('No user selected for deletion');
            return;
        }
        
        const confirmBtn = document.getElementById('confirm-delete-btn');
        const originalText = confirmBtn.innerHTML;
        
        try {
            // Show loading state
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deleting...';
            
            const response = await fetch('/api/delete-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: userToDelete.id
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to delete user');
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Success - close modal and refresh users list
                closeDeleteModal();
                showSuccessMessage(`User ${userToDelete.full_name || userToDelete.username} has been deleted successfully.`);
                fetchUsers(); // Refresh the users list
            } else {
                throw new Error(data.message || 'Failed to delete user');
            }
            
        } catch (error) {
            console.error('Error deleting user:', error);
            showErrorMessage('Failed to delete user. Please try again.');
            
            // Reset button state
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        }
    }
    
    // Membership management
    let currentMembershipUser = null;
    
    function manageMembership(userId) {
        const user = usersData.find(u => u.id == userId);
        if (user) {
            currentMembershipUser = user;
            showMembershipModal(user);
        } else {
            console.error('User not found:', userId);
        }
    }
    
    function showMembershipModal(user) {
        const modal = document.getElementById('membership-modal');
        const userInfo = document.getElementById('membership-user-info');
        const activeCheckbox = document.getElementById('membership-active-checkbox');
        const typeSelect = document.getElementById('membership-type-select');
        const endDateInput = document.getElementById('membership-end-date');
        const timezoneSpan = document.getElementById('user-timezone');
        
        const avatar = user.avatar_url ? 
            `<img src="${user.avatar_url}" alt="${user.full_name}" class="w-12 h-12 rounded-full object-cover">` :
            `<div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                <span class="text-white font-semibold">${getInitials(user.full_name)}</span>
            </div>`;
        
        userInfo.innerHTML = `
            <div class="flex items-center space-x-3 p-3 bg-slate-700 rounded-lg">
                ${avatar}
                <div>
                    <h3 class="text-white font-semibold">${user.full_name || 'N/A'}</h3>
                    <p class="text-gray-400 text-sm">@${user.username || 'N/A'}</p>
                    <p class="text-gray-400 text-sm">${user.email || 'N/A'}</p>
                </div>
            </div>
        `;
        
        // Populate form with current values
        activeCheckbox.checked = user.membership_active || false;
        typeSelect.value = user.membership_type || 'Basic';
        
        // Handle membership end date
        if (user.membership_end_date) {
            // Convert UTC date to local datetime-local format
            const endDate = new Date(user.membership_end_date);
            const localDateTime = new Date(endDate.getTime() - endDate.getTimezoneOffset() * 60000);
            endDateInput.value = localDateTime.toISOString().slice(0, 16);
        } else {
            // Set default to 1 month from now
            const futureDate = new Date();
            futureDate.setMonth(futureDate.getMonth() + 1);
            const localDateTime = new Date(futureDate.getTime() - futureDate.getTimezoneOffset() * 60000);
            endDateInput.value = localDateTime.toISOString().slice(0, 16);
        }
        
        // Display user's timezone
        const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        timezoneSpan.textContent = userTimezone;
        
        modal.classList.remove('hidden');
    }
    
    function closeMembershipModal() {
        document.getElementById('membership-modal').classList.add('hidden');
        currentMembershipUser = null;
    }
    
    
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
        fetchUsers();
    });
    
    // Add utility functions for success/error messages
    function showSuccessMessage(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    function showErrorMessage(message) {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <span>${message}</span>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
    }
    
    // Enable/disable delete button based on confirmation input
    document.getElementById('delete-confirmation-input').addEventListener('input', function(e) {
        const confirmBtn = document.getElementById('confirm-delete-btn');
        confirmBtn.disabled = e.target.value !== 'DELETE';
    });
    
    // Close modal when clicking outside
    document.getElementById('delete-confirmation-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    
    // Handle Enter key in confirmation input
    document.getElementById('delete-confirmation-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value === 'DELETE') {
            executeDeleteUser();
        }
    });
    
    // Create User Modal Functions
    function showCreateUserModal() {
        document.getElementById('create-user-modal').classList.remove('hidden');
        // Reset form
        document.getElementById('create-user-form').reset();
    }
    
    function closeCreateUserModal() {
        document.getElementById('create-user-modal').classList.add('hidden');
        document.getElementById('create-user-form').reset();
    }
    
    // Handle create user form submission
    document.getElementById('create-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('create-user-btn');
        const originalText = submitBtn.innerHTML;
        
        try {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            
            // Gather form data
            const formData = {
                full_name: document.getElementById('create-full-name').value.trim(),
                username: document.getElementById('create-username').value.trim(),
                email: document.getElementById('create-email').value.trim(),
                card_id: document.getElementById('create-card-id').value.trim() || null,
                phone: document.getElementById('create-phone').value.trim() || null
            };
            
            // Validate required fields
            if (!formData.full_name || !formData.username || !formData.email) {
                throw new Error('Please fill in all required fields');
            }
            
            const response = await fetch('/api/create-user', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to create user');
            }
            
            if (result.success && result.user_id) {
                closeCreateUserModal();
                showSuccessMessage(`User "${formData.full_name}" created successfully!`);
                
                // Redirect to edit user page
                setTimeout(() => {
                    window.location.href = `/dashboard/edit-user/${result.user_id}`;
                }, 1000);
            } else {
                throw new Error(result.message || 'Failed to create user');
            }
            
        } catch (error) {
            console.error('Error creating user:', error);
            showErrorMessage(error.message || 'Failed to create user. Please try again.');
            
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    // Close create modal when clicking outside
    document.getElementById('create-user-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeCreateUserModal();
        }
    });
    
    // Close modal with Escape key (update existing function)
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const deleteModal = document.getElementById('delete-confirmation-modal');
            const userModal = document.getElementById('user-detail-modal');
            const createModal = document.getElementById('create-user-modal');
            
            if (!deleteModal.classList.contains('hidden')) {
                closeDeleteModal();
            } else if (!userModal.classList.contains('hidden')) {
                closeUserModal();
            } else if (!createModal.classList.contains('hidden')) {
                closeCreateUserModal();
            }
        }
    });
</script>
</body>
</html>